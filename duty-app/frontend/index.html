<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å€¼æ—¥é€š - è‡ªåŠ¨ç”Ÿæˆç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-10">

  <h1 class="text-3xl font-bold mb-6 text-blue-700">ğŸ§¹ å€¼æ—¥é€š - è‡ªåŠ¨æ’ç­ç³»ç»Ÿ</h1>

  <!-- ä¸Šä¼ åå• -->
  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-md mb-8">
    <h2 class="text-xl font-semibold mb-3 text-gray-700">ğŸ‘¥ å¯¼å…¥æˆå‘˜åå•</h2>
    <input id="fileInput" type="file" accept=".json,.xlsx,.csv" class="mb-3 w-full border rounded p-2" />
    <div class="flex gap-2 mb-3">
      <button id="uploadBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
        ä¸Šä¼ åå•
      </button>
      <button id="downloadBtn" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">
        å¯¼å‡ºå½“å‰åå•
      </button>
    </div>
    <p id="memberInfo" class="text-sm text-gray-500 mt-2"></p>
  </div>

  <!-- ç”Ÿæˆå‚æ•° -->
  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-md mb-8">
    <label class="block mb-3">
      <span class="text-gray-700">ä¸Šè¯¾å¤©æ•°ï¼š</span>
      <input id="days" type="number" class="border rounded p-2 w-full" placeholder="ä¾‹å¦‚ 5" />
    </label>

    <label class="block mb-3">
      <span class="text-gray-700">æ¯æ—¥å€¼æ—¥äººæ•°ï¼š</span>
      <input id="people" type="number" class="border rounded p-2 w-full" placeholder="ä¾‹å¦‚ 2" />
    </label>

    <label class="block mb-3">
      <span class="text-gray-700">å¼€å§‹æ—¥æœŸï¼š</span>
      <input id="startDate" type="date" class="border rounded p-2 w-full" />
    </label>

    <button id="generateBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full">
      ç”Ÿæˆå€¼æ—¥è®¡åˆ’
    </button>
  </div>

  <!-- ç»“æœè¡¨æ ¼ -->
  <div id="resultSection" class="bg-white shadow-md rounded-xl p-6 w-full max-w-2xl hidden">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">ç”Ÿæˆç»“æœ</h2>
    <table class="min-w-full border border-gray-300 rounded-xl">
      <thead class="bg-blue-100">
        <tr>
          <th class="border p-2">æ—¥æœŸ</th>
          <th class="border p-2">å€¼æ—¥ç»„</th>
        </tr>
      </thead>
      <tbody id="resultTable"></tbody>
    </table>
  </div>
<!-- ç›‘ç£è®°å½•åŒºåŸŸ -->
<div id="superviseArea" class="mt-8 hidden">
  <h2 class="text-xl font-bold mb-3">ç›‘ç£è®°å½•</h2>

  <label class="block mb-3">
    <span class="text-gray-700">æ˜¯å¦å®Œæˆï¼ˆ1 å®Œæˆ / 0 æœªå®Œæˆï¼‰ï¼š</span>
    <input id="finished" type="number" min="0" max="1" class="border p-2 rounded w-full">
  </label>

  <label class="block mb-3">
    <span class="text-gray-700">æ•´æ´åº¦è¯„åˆ†ï¼ˆ1â€“10ï¼‰ï¼š</span>
    <input id="cleanScore" type="number" min="1" max="10" class="border p-2 rounded w-full">
  </label>

  <label class="block mb-3">
    <span class="text-gray-700">åé¦ˆè¯„è®ºï¼š</span>
    <textarea id="comment" class="border p-2 rounded w-full"></textarea>
  </label>

  <button id="superviseBtn" class="bg-green-600 text-white rounded p-2 w-full">æäº¤ç›‘ç£</button>
</div>

  <script>
    const uploadBtn = document.getElementById("uploadBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const fileInput = document.getElementById("fileInput");
    const memberInfo = document.getElementById("memberInfo");

    const btn = document.getElementById("generateBtn");
    const tableBody = document.getElementById("resultTable");
    const resultSection = document.getElementById("resultSection");

    // ä¸Šä¼ åå•å¹¶è‡ªåŠ¨è¡¥å…¨ç¼ºå¤±å­—æ®µ
    uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) return alert("è¯·é€‰æ‹©ä¸€ä¸ªåå•æ–‡ä»¶ï¼ˆæ”¯æŒ .json / .xlsx / .csvï¼‰");

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch("http://localhost:3000/upload-members", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "ä¸Šä¼ å¤±è´¥");

        // è‡ªåŠ¨è¡¥å…¨å­—æ®µå¹¶ç”Ÿæˆæ±‡æŠ¥
        const report = [];
        data.members.forEach(m => {
          const fixes = [];
          if (m.èƒ½åŠ› === undefined) { m.èƒ½åŠ› = 5; fixes.push("èƒ½åŠ›=5"); }
          if (m.å¯ç”¨ === undefined) { m.å¯ç”¨ = 1; fixes.push("å¯ç”¨=1"); }
          if (m.æ¬¡æ•° === undefined) { m.æ¬¡æ•° = 0; fixes.push("æ¬¡æ•°=0"); }
          if (fixes.length) report.push(`${m.name}: ${fixes.join(", ")}`);
        });

        memberInfo.innerHTML = `âœ… æˆåŠŸå¯¼å…¥ ${data.count} åæˆå‘˜` +
          (report.length ? `<br>âš ï¸ ä»¥ä¸‹æˆå‘˜å­—æ®µè¢«è‡ªåŠ¨è¡¥å…¨ï¼š<br>${report.join("<br>")}` : "");

      } catch (e) {
        alert("æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š" + e.message);
      }
    });

    // å¯¼å‡ºå½“å‰åå•
    downloadBtn.addEventListener("click", () => {
      window.location.href = "http://localhost:3000/download-members";
    });

    // ç”Ÿæˆå€¼æ—¥è®¡åˆ’
    btn.addEventListener("click", async () => {
      const days = document.getElementById("days").value;
      const people = document.getElementById("people").value;
      const startDate = document.getElementById("startDate").value;

      if (!days || !people || !startDate) {
        alert("è¯·å¡«å†™æ‰€æœ‰å‚æ•°ï¼");
        return;
      }

      tableBody.innerHTML = "";

      try {
        const response = await fetch("http://localhost:3000/generate-duty", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            days: Number(days),
            peoplePerDay: Number(people),
            startDate
          })
        });

        if (!response.ok) throw new Error("åç«¯å“åº”é”™è¯¯");

        const data = await response.json();
        resultSection.classList.remove("hidden");

        // å®‰å…¨æ¸²æŸ“ group
        data.days.forEach((item, i) => {
          const tr = document.createElement("tr");
          const groupDisplay = Array.isArray(item.group)
            ? item.group.join("ã€")
            : "âš ï¸ æ— æ³•ç”Ÿæˆ";
          tr.innerHTML = `
            <td class="border p-2 text-center">${item.date || `ç¬¬ ${i + 1} å¤©`}</td>
            <td class="border p-2 text-center">${groupDisplay}</td>
          `;
          tableBody.appendChild(tr);
        });
// æ˜¾ç¤ºç›‘ç£åŒºåŸŸ
document.getElementById("superviseArea").classList.remove("hidden");

// æœ€æ–°ä¸€å¤©çš„å€¼æ—¥ç»„ï¼ˆç”¨äºç›‘ç£ï¼‰
let lastGroup = data.days[data.days.length - 1].group;

document.getElementById("superviseBtn").onclick = async () => {
  const finished = Number(document.getElementById("finished").value);
  const cleanScore = Number(document.getElementById("cleanScore").value);
  const comment = document.getElementById("comment").value;

  try {
    const res = await fetch("http://localhost:3000/submit-supervise", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        group: lastGroup,
        finished,
        cleanScore,
        comment
      })
    });

    const result = await res.json();
    alert("ç›‘ç£æäº¤æˆåŠŸï¼");
  } catch (err) {
    alert("ç›‘ç£æäº¤å¤±è´¥ï¼š" + err.message);
  }
};

      } catch (err) {
        alert("ç”Ÿæˆå¤±è´¥ï¼š" + err.message);
      }
    });
  </script>
</body>
</html>
