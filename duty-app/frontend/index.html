<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta-name="viewport" content="width=device-width, initial-scale=1" />
  <title>å€¼æ—¥é€š Â· ç³»ç»Ÿ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    html,body{height:100%;overflow:hidden;background:#f5f7fa;}
    .layout{display:flex;gap:20px;width:100%;max-width:1300px;height:calc(100vh - 90px);}
    .panel{background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);padding:20px;overflow:auto;}
    .left-panel{width:420px;flex-shrink:0;display:flex;flex-direction:column;gap:20px;}
    .right-panel{flex:1;display:flex;flex-direction:column;gap:20px;}
    .dates-list{display:flex;flex-direction:column;gap:8px;overflow:auto;max-height:260px;}
    .supervise-section{flex:1;overflow:auto;}
  </style>
</head>

<body class="flex flex-col items-center py-5">

  <h1 class="text-3xl font-bold mb-4 text-blue-700">ğŸ§¹ å€¼æ—¥é€š</h1>

  <div class="layout">

    <!-- Left Panel -->
    <div class="left-panel">

      <!-- ä¸Šä¼ åå• & å‚æ•° -->
      <div class="panel">
        <h2 class="text-xl font-semibold mb-3">åå• & ç”Ÿæˆ</h2>

        <div class="space-y-3">

          <div>
            <label class="text-gray-700 block mb-1">ä¸Šä¼ åå• (.json/.xlsx/.csv)</label>
            <input id="fileInput" type="file" accept=".json,.xlsx,.csv" class="border rounded p-2 w-full" />
          </div>

          <div>
            <label class="text-gray-700 block mb-1">ä¸Šè¯¾å¤©æ•°</label>
            <input id="days" type="number" class="border rounded p-2 w-full" placeholder="ä¾‹å¦‚ 5" />
          </div>

          <div>
            <label class="text-gray-700 block mb-1">æ¯æ—¥å€¼æ—¥äººæ•°</label>
            <input id="people" type="number" class="border rounded p-2 w-full" placeholder="ä¾‹å¦‚ 2" />
          </div>

          <div>
            <label class="text-gray-700 block mb-1">å¼€å§‹æ—¥æœŸ</label>
            <input id="startDate" type="date" class="border rounded p-2 w-full" />
          </div>

          <div class="flex gap-2 pt-2">
            <button id="uploadBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded">ä¸Šä¼ åå•</button>
            <button id="generateBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">ç”Ÿæˆåå•</button>
          </div>

          <div>
            <button id="downloadBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded">å¯¼å‡ºåå•</button>
          </div>

          <div>
            <button id="updateWeekBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded">æ›´æ–°åˆ°ä¸‹ä¸€å‘¨</button>
          </div>

          <p id="memberInfo" class="text-sm text-gray-500"></p>
        </div>
      </div>

      <!-- æ—¥æœŸåˆ—è¡¨ -->
      <div class="panel">
        <h2 class="text-lg font-semibold mb-2">æœ¬å‘¨æ—¥æœŸ</h2>
        <div id="datesList" class="dates-list text-sm text-gray-600">
          ï¼ˆç”Ÿæˆå€¼æ—¥åæ˜¾ç¤ºæ—¥æœŸï¼‰
        </div>
      </div>

      <!-- ç”Ÿæˆç»“æœ -->
      <div class="panel">
        <h2 class="text-lg font-semibold mb-2">å€¼æ—¥åå•</h2>
        <table class="min-w-full border border-gray-300 rounded">
          <thead class="bg-blue-100 text-sm">
            <tr>
              <th class="border p-1">æ—¥æœŸ</th>
              <th class="border p-1">å°ç»„</th>
            </tr>
          </thead>
          <tbody id="resultTable" class="text-sm"></tbody>
        </table>
      </div>

    </div>

    <!-- Right Panel -->
    <div class="right-panel">

      <!-- ç›‘ç£ç¼–è¾‘åŒº -->
      <div class="panel supervise-section" id="todaySupervise" style="display:none;">
        <h2 class="text-xl font-semibold mb-3">ç›‘ç£</h2>

        <div id="todayInfo" class="mb-3 text-gray-700 text-sm"></div>

        <div id="individualInputs" class="space-y-3 mb-4"></div>

        <label class="block mb-1 text-gray-700">ç•™è¨€ï¼š</label>
        <textarea id="dayComment" class="border rounded p-2 w-full mb-4" rows="2"></textarea>

        <div class="flex gap-2">
          <button id="submitTodayBtn"
                  class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
            æäº¤ç›‘ç£
          </button>
          <div id="submitStatus" class="text-sm text-gray-600 self-center"></div>
        </div>
      </div>

      <!-- æŸ¥çœ‹ç›‘ç£è®°å½• -->
      <div class="panel supervise-section" id="viewSupervise" style="display:none;">
        <h2 class="text-xl font-semibold mb-3">ç›‘ç£è®°å½•</h2>
        <div id="viewDate" class="font-medium mb-2"></div>
        <div id="viewComment" class="text-gray-700 mb-3 text-sm"></div>
        <div id="viewIndividuals" class="space-y-2 text-sm"></div>
      </div>

    </div>
  </div>

  <script>
    function formatDate(d){return new Date(d).toISOString().split("T")[0];}

    let currentGeneratedDays=[];
    let membersCount=0;

    const uploadBtn=document.getElementById("uploadBtn");
    const fileInput=document.getElementById("fileInput");
    const generateBtn=document.getElementById("generateBtn");
    const memberInfo=document.getElementById("memberInfo");
    const resultTable=document.getElementById("resultTable");
    const downloadBtn=document.getElementById("downloadBtn");
    const updateWeekBtn=document.getElementById("updateWeekBtn");

    const datesList=document.getElementById("datesList");
    const todaySupervise=document.getElementById("todaySupervise");
    const individualInputs=document.getElementById("individualInputs");
    const dayComment=document.getElementById("dayComment");
    const submitTodayBtn=document.getElementById("submitTodayBtn");
    const submitStatus=document.getElementById("submitStatus");

    const viewSupervise=document.getElementById("viewSupervise");
    const viewDate=document.getElementById("viewDate");
    const viewComment=document.getElementById("viewComment");
    const viewIndividuals=document.getElementById("viewIndividuals");

    uploadBtn.onclick=async()=>{
      const file=fileInput.files[0];
      if(!file)return alert("è¯·é€‰æ‹©æ–‡ä»¶");

      const fd=new FormData();
      fd.append("file",file);

      try{
        const res=await fetch("/upload-members",{method:"POST",body:fd});
        const data=await res.json();
        if(!res.ok)throw new Error(data.error);
        membersCount=data.count||0;
        memberInfo.innerText=`å·²å¯¼å…¥ ${membersCount} åæˆå‘˜`;
      }catch(e){alert("æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š"+e.message);}
    };

    downloadBtn.onclick=()=>{location.href="/download-members";};

    updateWeekBtn.onclick=async()=>{
      try{
        const res=await fetch("/update-week",{method:"POST"});
        const j=await res.json();
        if(!res.ok)throw new Error(j.error);
        alert("æˆåŠŸæ›´æ–°åˆ°ä¸‹ä¸€å‘¨ âœ“");
      }catch(e){alert("æ›´æ–°å¤±è´¥ï¼š"+e.message);}
    };

    generateBtn.onclick=async()=>{
      const days=Number(document.getElementById("days").value);
      const people=Number(document.getElementById("people").value);
      const startDate=document.getElementById("startDate").value;

      if(!days||!people||!startDate){return alert("è¯·å¡«å†™å®Œæ•´å‚æ•°");}

      resultTable.innerHTML="";
      datesList.innerHTML="";
      todaySupervise.style.display="none";
      viewSupervise.style.display="none";

      try{
        const res=await fetch("/generate-duty",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({days,peoplePerDay:people,startDate})
        });
        const data=await res.json();
        if(!res.ok)throw new Error(data.error);

        currentGeneratedDays=data.days;

        currentGeneratedDays.forEach(item=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td class="border p-1 text-center">${item.date}</td>
            <td class="border p-1 text-center">${item.group.join("ã€")}</td>`;
          resultTable.appendChild(tr);

          const btn=document.createElement("button");
          btn.className="p-2 rounded hover:bg-gray-100 text-left";
          btn.textContent=item.date;
          btn.onclick=()=>loadDay(item);
          datesList.appendChild(btn);
        });

      }catch(e){alert(e.message);}
    };

    function loadDay(item){
      setupTodayEditable(item.date,item.group);

      fetch(`/get-supervise?date=${item.date}`)
       .then(r=>r.json())
       .then(d=>{
         viewSupervise.style.display="block";
         viewDate.innerText=item.date+" çš„è®°å½•";

         if(!d.found){
           viewComment.innerText="æš‚æ— ç›‘ç£è®°å½•";
           viewIndividuals.innerHTML="";
           return;
         }

         viewComment.innerText=d.record.comment||"ï¼ˆæ— ç•™è¨€ï¼‰";
         viewIndividuals.innerHTML="";
         d.record.individuals.forEach(p=>{
           const div=document.createElement("div");
           div.className="p-2 border rounded";
           div.innerHTML=`<b>${p.name}</b> | å®Œæˆï¼š${p.completed?"æ˜¯":"å¦"} | è¯„åˆ†ï¼š${p.score||"-"} | å¤‡æ³¨ï¼š${p.comment||""}`;
           viewIndividuals.appendChild(div);
         });
       });
    }

    function setupTodayEditable(date,group){
      todaySupervise.style.display="block";
      viewSupervise.style.display="none";

      document.getElementById("todayInfo").innerText=`æ—¥æœŸï¼š${date}ï¼ˆ${group.join("ã€")}ï¼‰`;
      individualInputs.innerHTML="";
      dayComment.value="";
      submitStatus.innerText="";

      group.forEach(name=>{
        const row=document.createElement("div");
        row.className="flex gap-3 items-center";

        row.innerHTML=`
          <div class="w-32 font-medium">${name}</div>
          <select data-name="${name}" class="border rounded p-1">
            <option value="1">å·²å®Œæˆ</option>
            <option value="0">æœªå®Œæˆ</option>
          </select>
          <input type="number" min="1" max="10" data-name="${name}" class="border rounded p-1 w-20" placeholder="è¯„åˆ†" />
          <input type="text" data-name="${name}" class="border rounded p-1 flex-1" placeholder="å¤‡æ³¨" />
        `;

        individualInputs.appendChild(row);
      });

      submitTodayBtn.onclick=async()=>{
        const individuals=[];
        const rows=individualInputs.querySelectorAll("div");

        rows.forEach(r=>{
          const name=r.querySelector("div").innerText;
          const completed=r.querySelector("select").value;
          const score=r.querySelector("input[type='number']").value;
          const comment=r.querySelector("input[type='text']").value;

          individuals.push({
            name,
            completed:Number(completed),
            score:score?Number(score):null,
            comment:comment||""
          });
        });

        const payload={
          date,
          group,
          comment:dayComment.value||"",
          individuals
        };

        submitStatus.innerText="æäº¤ä¸­...";
        submitTodayBtn.disabled=true;

        try{
          const r=await fetch("/submit-supervise",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(payload)
          });
          const j=await r.json();
          if(!r.ok)throw new Error(j.error);
          submitStatus.innerText="æäº¤æˆåŠŸ âœ“";
          loadDay({date,group});
        }catch(e){
          submitStatus.innerText="æäº¤å¤±è´¥ï¼š"+e.message;
        }finally{
          submitTodayBtn.disabled=false;
          setTimeout(()=>submitStatus.innerText="",2500);
        }
      };
    }
  </script>

</body>
</html>
